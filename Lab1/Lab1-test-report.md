# *Lab1 test report*

*from 我想开学队*

## 1.**实验概要**

多线程编程是高性能编程的技术之一，实验1将针对数独求解问题比较多线程与单线程的性能差异、同一功能不同代码实现的性能差异以及多线程在不同硬件环境下的性能差异。

------

### 1.1 程序输入

程序将在控制台接收用户输入，该输入为某一目录下的一个数独谜题文件，该文件包含多个数独谜题，每个数独谜题按固定格式存储在该文件中。

```
./test1 
./test2
./test3
```

### 1.2 程序输出

实验中把数独的解按与输入相对应的顺序直接输出到屏幕。

```
312647985786953241945128367854379126273461859691285473437592618569814732128736594
693784512487512936125963874932651487568247391741398625319475268856129743274836159 
869725413512934687374168529798246135231857946456319872683571294925483761147692358
693784512487512936125963874932651487568247391741398625319475268856129743274836159
364978512152436978879125634738651429691247385245389167923764851486512793517893246
378694512564218397291753684643125978712869453859437261435971826186542739927386145
```

### 1.3 **Sudoku算法**

实验共提供了4种不同的Sudoku求解算法：BASIC,DANCE,MINA和MINAC。其中，DANCE算法速度最快，BASIC算法速度最慢。本次实验中选用的是最快的DANCE算法。

### 1.4 性能指标

实验以求解完单个输入文件里的所有数独题并把数独的解按顺序写入文件所需要的时间开销作为性能指标。一般而言，可以用**加速比**直观地表示并行程序与串行程序之间的性能差异（加速比：串行执行时间与并行执行时间的比率，是串行与并行执行时间之间一个具体的比较指标）。

为了精确地测量性能，时间开销均在数独求解进程/线程绑定CPU的某个核的条件下测得，这样保证了该进程/线程不被调度到其他核中运行，但不保证该进程/线程独占某个核。更精确的测量方法可以先把CPU的某个核隔离，而后再绑定在某个进程/线程上，这样该CPU核心不会运行其他的用户程序。当CPU资源充足时（CPU核心数足够多，当前正在运行的进程/线程足够少），是否把核隔离并没有多大影响，因为操作系统的调度策略不会频繁的对线程/进程进行无谓的调度。

### 1.5 实验环境

实验中共有4个不同的实验环境：

- **ENV1 周蜜**

  Linux内核版本为5.3.0-42-generic；2GB内存；20GB硬盘；供应商ID为AuthenticAMD；CPU型号为AMD Ryzen 5 2500U with Radeon Vega Mobile Gfx，共1个物理CPU；每个物理CPU有1个物理核心，共有1个物理核心；使用超线程技术，1个物理核心模拟出1个逻辑核心，共有1个逻辑核心。

- **ENV2 林子翔**

  Linux内核版本为4.15.0-91-generic；2GB内存；20GB硬盘；供应商ID为GenuineIntel；CPU型号为Intel(R) Core(TM) i5-9400F CPU @ 2.90GHz，共1个物理CPU；每个物理CPU有1个物理核心，共有1个物理核心；使用超线程技术，1个物理核心模拟出1个逻辑核心，共有1个逻辑核心。

- **ENV3 胡卓韬**

  Linux内核版本为5.3.0-42-generic；2GB内存；供应商ID为GenuineIntel；CPU型号为Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz，共1个物理CPU；每个物理CPU有1个物理核心，共有1个物理核心；使用超线程技术，1个物理核心模拟出1个逻辑核心，共有1个逻辑核心。

- **ENV4 邓彬**

  linux内核版本为4.4.0-18362-Microsoft；8GB内存；供应商ID为Samsung；CPU型号为 Intel(R) Core(TM) i5-7300HQ CPU @2.50Ghz，共1个物理CPU；每个物理CPU共有1个物理核心，共有1个物理核心；使用超线程技术，1个物理核心模拟出1个逻辑核心，共有1个逻辑核心。

如无特别说明，默认使用ENV1。

### 1.6 代码实现版本

实验中共使用两份不同的代码：**Code1**和**Code2**。

- **Code1**:

  原生的数独求解代码，即本实验中老师所提供的代码，只能以单线程模式运行。

- **Code2**:

  为适应多线程在Code1上进行了一系列的修改和增添而成。在Code2中，修改了文件的输入方式以满足实验的输入格式要求。对于一次输入中的不同文件，以文件内数独行数为标识来控制线程求解不同文件内的数独题目。主要求解数独的任务由sudoku_solve线程完成。与Code1相比，Code2的代码量多了100行左右。

如无特别说明，默认使用Code2。



## 2.**性能测试**

程序的性能会受到诸多因素的影响，其中包括软件层面的因素和硬件层面的因素。本节将分析比较多线程程序与单线程程序的性能差异、同一功能不同代码实现的性能差异，以及同一个程序在不同硬件环境下的性能差异。

本测试遵循单一变量原则，变量包括：代码种类，使用线程数数量，执行文件大小及硬件种类。

-----

### 2.1 多线程与单线程性能比较

单线程程序只能利用1个CPU核心，而多线程程序能使CPU的多个核心并行运作，因此，多线程能够充分发挥多核CPU的优势。在一定范围内，加速比会随着线程数的增加而增长，即时间开销越少、效率越高。当线程数超过CPU核心数时，性能会有所下降。

为了比较多线程与单线程性能差异，本测试运行1个大小为84.0 MB、具有1024 K个数独题的文件，而后分别使用单个sudoku_solve线程和n个sudoku_solve线程分别对该文件内的所有数独题进行求解，并把解输出到屏幕上，测量这一部分所需要的时间开销并计算加速比。

下图展示了不同线程数对性能造成的影响，其2条折线：**time**和**speedup**分别表示随sodoku_solve线程数量的变化所需的时间开销和相应的加速比。

由于测试的硬件CPU物理核心数只有1个，所以从sudoku_solve线程数为1开始，总线程数开始超过CPU物理核心数，线程开始被操作系统调度，调度会有一定的开销，所以性能会有所下降。

[图1](https://github.com/Mizhoum/CloudComputingLabs/blob/master/1.png)

### 2.2 不同代码实现性能比较

对于实现同一功能的程序，可以有多种不同的代码实现，不同的代码实现在时间开销上不一定会相同。实验中使用的Code2比Code1多了一些额外的代码段，因此Code2的时间开销要略大于Code1，并且随着问题规模的增大，差距也会愈加明显。

考虑到代码可读性、可扩展性或其他因素，有时会在代码实现上增加一些额外的代码段。当这些额外的代码段被调用的次数足够多时，其所造成的时间开销会逐渐显现出来。

本测试将使用2份不同的代码进行性能比较：Code1和Code2。运行7个不同大小的文件，每个文件分别有数独题：1、10、20、40、60、80、100个。分别用Code1和Code2对这些文件进行求解（此处Code1和Code2都是使用单个数独求解线程进行求解），并测量时间开销。

[图2](https://github.com/Mizhoum/CloudComputingLabs/blob/master/2.png)

上图显示数独题量从1 增长到100时，Code1与Code2之间的时间开销差距逐渐拉大。由于Code1在测试时的表现效果太差，仅仅是数独题量为100的时候，时间开销也高达3分钟，因此本次测试数独题量才全部定在100以下。从图中我们可以看到，随着数独题量的成倍增长，Code1与Code2的时间开销基本也在成倍增长。

### 2.3 不同硬件环境性能比较

硬件环境如CPU主频（其它如物理CPU个数、物理核心数等）的不同，会导致同一个程序在不同的硬件环境中有不同的表现。对单个CPU物理核心，其主频越高，运行速度越快。

实验将使用Code2分别在ENV1-ENV4中对大小为84.0MB、具有1024 K个数独题的文件进行求解，其中sudoku_solve线程数从1开始逐步增加，测量时间开销。

[图3](https://github.com/Mizhoum/CloudComputingLabs/blob/master/3.png)

上图为Code2在不同的硬件环境ENV1-ENV4中分别调整不同的sudoku_solve线程数的测试结果。可以看出，由于硬件环境ENV1-ENV4全部为单核CPU，所以主频 (CPU内核工作的时钟频率) 越高，运行速度越快。当线程数超过物理核心数 (或者逻辑核心) 1时，其性能会因为线程的调度而出现下降的趋势。



## 3.by the way

在实验过程中，由于组长 (没错我本人) 有过一次清仓误操作，所以可能组员们上传记录会比较少，望见谅；上述测试数据并没有经过多次求均值，所以可能在某些地方不太准确，望海涵。

----
